# Cat & Content Bounded Context — Architecture Decisions & Diagrams

This document captures the **decisions, constraints, and representations** agreed on in this conversation for the *Cat & Content* bounded context, using the Rampart framework.

It is intended to be:
- **Diagram-authoritative** (L1–L3)
- **Agent-friendly** (clear boundaries, orchestration, and invariants)
- **Non-duplicative** with framework-level rules

This document explicitly excludes C4-specific framing and diagrams.

---

## 1. Architecture JSON: What Belongs vs What Does Not

### Core Principle

The `architecture.json` for a bounded context is **normative and curated**, not an inventory.

It encodes:
- Stable architectural intent
- Diagram-stable components
- Constraints agents cannot reliably infer from code

It does **not** attempt to mirror the codebase.

---

## 2. Framework vs Project Responsibility

### Framework / Profile-Level (NOT repeated per BC)

Enforced by Rampart profile (e.g. `rampart_hexddd_v1`):
- Domain never depends on Application or Infrastructure
- Application never depends on Infrastructure implementations
- Infrastructure implements ports only
- Hexagonal layering rules
- Standard transaction semantics

These rules **must exist**, but do **not** belong in each BC’s `architecture.json`.

### Project-Level (Belongs in architecture.json)

Only **deltas and semantics**:
- What components exist in *this* BC
- Which ports are used
- Which adapters are bound
- Which aggregates are orchestrated by which services
- Which events are published
- Rails-only-in-infrastructure constraint

---

## 3. Diagrams: Authority and Scope

### Diagram Levels

Architecture JSON is authoritative for:
- **L1** — Bounded Context overview
- **L2** — Layered architecture (Domain / Application / Infrastructure)
- **L3** — Curated key components

It is **not authoritative** for:
- Full class inventories
- Value objects
- Helpers
- Internal wiring details

Those belong to a **generated index overlay**.

### Derived Overlay (Planned)

- `index.json` generated by Rampart
- Exhaustive inventory (classes, dependencies)
- Used for:
  - Enforcement
  - Diagnostics
  - Optional detailed diagrams

Architecture JSON remains the *source of truth*.

---

## 4. What Appears in Diagrams

### INCLUDED (Curated)

- Bounded Context
- Layers (Domain / Application / Infrastructure)
- Aggregates
- Application services
- Ports (interfaces)
- Adapters (at type level)
- Controllers (entrypoints)
- Domain events
- External systems (LLMs, DB, Event Bus)

### EXCLUDED (Derived / Too Noisy)

- Value objects (Money, Slug, etc.)
- Internal entities unless diagram-relevant
- Helper services
- ActiveRecord column details
- File-by-file class lists

Rule of thumb:
> If refactoring code would require updating `architecture.json`, it probably doesn’t belong there.

---

## 5. Rampart Index Generation

### Decision

Rampart **should** provide index generation, but:
- It is **non-normative**
- It complements, not replaces, architecture JSON

### Initial Scope (80/20)

- Convention-based scanning
- Component inventory
- Module-level dependency graph
- Profile + project constraint validation

### Future Enhancements

- Aggregate detection
- Event payload extraction
- Multi-language analyzers
- Auto-suggested architecture updates

---

## 6. ASCII Diagrams (Authoritative)

### L1 — Bounded Context Overview

```
+----------------------------------------------------+
|            Cat & Content Bounded Context            |
|                                                    |
|  - Premade cat listings (catalog)                  |
|  - User-generated custom cats (AI)                 |
|  - AI-generated copy & media                       |
+--------------------------+-------------------------+
                           |
        +------------------+------------------+
        |                                     |
   Primary Entry Points                External Dependencies
        |                                     |
+----------------------+        +---------------------------+
| HTTP Controllers     |        | OpenAI / Claude APIs      |
| - CatListings        |        | (Language Models)         |
| - CustomCats         |        +---------------------------+
+----------------------+        | Event Bus (host app)      |
                                +---------------------------+
                                | AWS S3 (optional)         |
                                | Search Index (optional)   |
                                +---------------------------+
```

---

### L2 — Layered Architecture (Hexagonal)

```
┌──────────────────────────────────────────────────────────┐
│                        Domain (Pure Ruby)                 │
│                                                          │
│  Aggregates                                               │
│  ──────────                                               │
│  • CatListing                                             │
│  • CustomCat                                              │
│                                                          │
│  Entity                                                   │
│  ──────                                                   │
│  • CatProfile                                             │
│                                                          │
│  Domain Events                                            │
│  ─────────────                                           │
│  • CatListingPublished                                    │
│  • CatListingArchived                                     │
│  • CustomCatCreated                                       │
│  • CustomCatArchived                                      │
│  • CatDescriptionRegenerated                              │
│                                                          │
│  Secondary Ports (Interfaces)                             │
│  ───────────────────────────                             │
│  • CatListingRepository                                   │
│  • CustomCatRepository                                    │
│  • LanguageModelPort                                      │
│  • ClockPort / IdGeneratorPort / TransactionPort          │
└──────────────────────────────────────────────────────────┘
                ▲                         ▲
                | uses ports              | emits events
                |
┌──────────────────────────────────────────────────────────┐
│                     Application (Pure Ruby)               │
│                                                          │
│  Application Services                                     │
│  ───────────────────                                     │
│  • CatListingService                                      │
│  • CustomCatService                                       │
│                                                          │
│  Commands / Queries                                       │
│  ─────────────────                                       │
│  • CreateCatListing                                       │
│  • GenerateCustomCat                                      │
│  • ArchiveCustomCat                                       │
│  • ListCatListings / ListCustomCats                       │
│                                                          │
│  - Orchestrates domain aggregates                         │
│  - Manages transactions                                  │
│  - Publishes domain events                                │
└──────────────────────────────────────────────────────────┘
                ▲
                | invokes
┌──────────────────────────────────────────────────────────┐
│                Infrastructure (Rails ONLY)                │
│                                                          │
│  HTTP                                                     │
│  ────                                                    │
│  • CatListingsController                                  │
│  • CustomCatsController                                   │
│  • Serializers                                            │
│                                                          │
│  Persistence                                              │
│  ───────────                                             │
│  • ActiveRecord models                                    │
│  • Mappers                                                │
│  • SQL Repositories (implement domain ports)              │
│                                                          │
│  Adapters                                                 │
│  ───────                                                 │
│  • OpenAI / Claude LanguageModelAdapter                   │
│  • SystemClockAdapter                                     │
│  • UUIDIdGeneratorAdapter                                 │
│  • DatabaseTransactionAdapter                              │
│                                                          │
│  Wiring                                                   │
│  ──────                                                  │
│  • Dry::Container                                         │
└──────────────────────────────────────────────────────────┘
```

---

### L3 — Key Component Interaction (Curated)

#### Premade Cat Listings

```
[CatListingsController]
          |
          v
[CatListingService]
    |        |        |
    |        |        +--> [ClockPort]
    |        +------------> [IdGeneratorPort]
    +---------------------> [TransactionPort]
    |
    v
[CatListingRepository] <---- implemented by ---- [SqlCatListingRepository]
    |
    v
[CatListing Aggregate]
    |
    +--> emits events:
          - CatListingPublished
          - CatListingArchived
```

#### Custom Cat (AI-Generated)

```
[CustomCatsController]
          |
          v
[CustomCatService]
    |        |        |        |
    |        |        |        +--> [ClockPort]
    |        |        +------------> [IdGeneratorPort]
    |        +---------------------> [TransactionPort]
    +------------------------------> [LanguageModelPort]
                                        |
                                        +--> OpenAI Adapter
                                        +--> Claude Adapter (optional)
    |
    v
[CustomCatRepository] <---- implemented by ---- [SqlCustomCatRepository]
    |
    v
[CustomCat Aggregate]
    |
    +--> emits events:
          - CustomCatCreated
          - CustomCatArchived
          - CatDescriptionRegenerated
```

---

## 7. Intentional Non-Goals

This architecture deliberately avoids:
- Treating architecture JSON as code documentation
- Encoding framework-level invariants redundantly
- Diagramming every class
- Locking implementation details into diagrams

The goal is **clarity, stability, and enforceable intent**.

---

## 8. Summary

- Architecture JSON = *what must be true*
- Index generation = *what currently exists*
- Diagrams are curated, human-readable, and agent-safe
- Rampart profile enforces generic rules; BC JSON encodes semantics

This document is the canonical record of those decisions.

